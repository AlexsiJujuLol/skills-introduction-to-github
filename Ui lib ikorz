-- Load Kavo UI Library
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/xHeptc/Kavo-UI-Library/main/source.lua"))()
local Window = Library.CreateLib("Auto Parry", "DarkTheme")

-- Tabs and Sections
local MainTab = Window:NewTab("Main")
local SettingsTab = Window:NewTab("Settings")
local MainSection = MainTab:NewSection("Auto Parry")
local SettingsSection = SettingsTab:NewSection("Settings")

-- Services
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Variables
local Player = Players.LocalPlayer
local Cooldown = tick()
local Parried = false
local Connection = nil

getgenv().AutoParryEnabled = false
getgenv().DetectionRange = 50 -- Default detection range

-- Functions
local function GetBall()
    for _, Ball in ipairs(workspace.Balls:GetChildren()) do
        if Ball:GetAttribute("realBall") then
            return Ball
        end
    end
end

local function ResetConnection()
    if Connection then
        Connection:Disconnect()
        Connection = nil
    end
end

workspace.Balls.ChildAdded:Connect(function()
    local Ball = GetBall()
    if not Ball then return end
    ResetConnection()
    
    Connection = Ball:GetAttributeChangedSignal("target"):Connect(function()
        Parried = false
    end)
end)

local function detectAndTriggerParry()
    local Ball, HRP = GetBall(), Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
    if not Ball or not HRP then return end

    local Speed = Ball.zoomies.VectorVelocity.Magnitude
    local Distance = (HRP.Position - Ball.Position).Magnitude

    if Ball:GetAttribute("target") == Player.Name and not Parried and Distance / Speed <= 0.55 then
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        Parried = true
        Cooldown = tick()
    end

    if (tick() - Cooldown) >= 1 then
        Parried = false
    end
end

-- Auto Parry Logic
RunService.RenderStepped:Connect(function()
    if getgenv().AutoParryEnabled then
        detectAndTriggerParry()
    end
end)

-- UI Controls
MainSection:NewToggle("Enable Auto Parry", "Toggle Auto Parry feature on/off.", function(state)
    getgenv().AutoParryEnabled = state
    if state then
        print("[INFO] Auto Parry Enabled")
    else
        print("[INFO] Auto Parry Disabled")
    end
end)

MainSection:NewSlider("Detection Range", "Set the range to detect incoming balls.", 100, 10, function(value)
    getgenv().DetectionRange = value
    print("[INFO] Detection Range set to: " .. value)
end)

SettingsSection:NewKeybind("Toggle UI", "Show/Hide the UI.", Enum.KeyCode.RightShift, function()
    Library:ToggleUI()
end)

-- Initialization Message
print("[INFO] Auto Parry Script Loaded with Kavo UI!")
